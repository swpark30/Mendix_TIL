# module 9



## 앱 보안

- security rules 또는 access rules라고 한다.
- 누가 사용하는지 그 사용자가 어떤 것을 할 수 있는지 정할 수 있다.
- 보안 룰을 적용할 수 있는 3가지
  - 페이지
  - 마이크로플로우
  - 데이터(엔티티)
- 특정 페이지에 대한 엑세스 권한이 없으면 해당 페이지로 이동하는 버튼이나 탐색 항목이 자동으로 표시되지 않는다.
- 마이크로플로우에 대한 액세스 권한이 없으면 마이크로플로우를 트리거하는 버튼이 표시되지 않는다.
- 보안에는 2가지 다른 계층이 있다.
  - 앱 보안 (App scurity)
    - 보안 레벨을 설정하고 전체 앱에 대한 전반적인 보안 설정을 관리 한다.
  - 모듈 보안 (module scurity)
    - 앱의 각 개별 모듈에 대한 페이지, 마이크로플로우 및 엔티티 엑세스를 설정하는 곳이다.



### 보안 레벨

- Mendix  앱에는 3가지 보안 레벨이 있다.
  - Off
    - 보안이 없다. 누구나 앱을 사용할 수 있고 로그인이 필요없다
    - 앱을 처음 만들면 기본 설정으로 지정 되어있다.
  - Prototype/Demo
    - 페이지 액세스와 마이크로플로우 액세스를 설정 해야한다.
    - 누가 어떤 페이지를 방문할 수 있고 누가 어떤 마이크로플로우를 트리거 할 수 있는지 정해야한다.
    - 보안을 빠르게 확인(시연) 하는 데 유용하다.
  - Production
    - 엔티티 액세스를 구성한다.
    - 누가 객체를 만들 수 있고 삭제할 수 있는지 결정한다.
    - 누가 객체 내부의 정보를 볼 수 있는지와 해당 정보를 변경할 수 있는지 결정한다.
  - 프로토타입에서 프로덕션으로 전환한 경우 엔티티 액세스만 정하면 되지만 Off에서 프로덕션으로 바로 전환하면 페이지, 마이크로플로우, 엔티티 액세스를 한번에 정해야한다.



### 사용자와 Module roles

- 보안과 관련하여 가장 먼저 할일은 사용자 역할을 결정하는 것이다.
- 사용자가 로그인 하면 사용자 역할이 할당된다.
- 사용자는 해당 사용자 역할에 해당하는 액세스 규칙의 구성에의해 정해진 페이지, 마이크로플로우, 데이터에만 액세스 할 수 있다.
- 이러한 액세스 권한을 모듈 보안에서 관리한다.
- 각 모듈에 대해 특정 사용자가 할 수 있는 것과 할 수 없는 것을 포착하는 모듈 역할을 만들 수 있다.
- 각 모듈 역할이 페이지에 액세스 할 수 있는지, 마이크로플로우를 트리거하는 방법 및 데이터 객체를 조작할 수 있는 방법을 정할 수 있다.
- 특정한 사용자 역할에 모듈 역할이 할당 되어있지 않으면 이 사용자에게 전체 모듈은 자동으로 제한이 풀린다
- 사용자 역할은 모듈 역할에 대한 일종의 루트 역할을 한다.
- 각 사용자가 할 일에 맞게 모듈에 대한 권한을 주면 된다.



### 앱에는 중요한 3가지 모듈이 있다.

- MyFirstModule
  - 학습 과정에서 구성한 모듈
- System(변경할 수 없다)
  - 앱의 핵심 구조를 정하고 사용자 역할을 할당할 수 있게 해준다.
  - 편집은 불가하지만 다른 모든 것이 구성되는데 기반이 되는 모듈이다.
- Administration(관리)
  - 사용자의 계정을 생성하여 사용자 이름과 비밀번호로 앱에 로그인 할 수 있다.
- 관리와 시스템 모듈은 모든 앱이 생성될 때 기본적으로 포함되며 제대로 작동하기위해 필요하다.
- 각각에는 MyFirstModule 외에 자체 보안 설정이 있다.



### User roles과 Module roles을 구분하는 목적

- 각 모듈이 정의되거나 사용되는 프로젝트에서 독립적이고 독립적으로 만드는 것이다. 
- 모듈은 다른 프로젝트에서 재사용할 수 있으며 Mendix App Store에 게시할 수 있다.
- 앱 스토어에서 모듈을 다운로드하는 사람은 모든 페이지와 엔티티에 대한 액세스 규칙들을 구성하는데 시간을 보낼 필요가 없다.
- 새 모듈의 Module roles를 프로젝트의 user roles에 할당만 하면 된다.



### LearnNow 앱의 사용자 및 모듈 역할

- Administrator (jimmy)
- Teacher
- Trainee
- LearnNow 앱은 모든 송장 및 지불을 처리 하는 송장 발행 모듈로 확장될 수 있다.
- 송장 발행 모듈에서 자체적으로 일치하는 모듈역할이 있는 재무 사용자 역할도 추가해야한다.
- 사용자 역할이 모든 모듈에 연결될 필요는 없다.
- 사용자는 앱에서 둘 이상의 사용자 역할을 가질 수 있다.



## App Security 설정

1. App Explorer에서 Security를 더블 클릭하여 연다.
2. 보안 레벨을 Prototype/Demo로 설정하면 설정창이 바뀌면서 관리를 할 수 있다.
   - 첫번째 탭은 Module status(모듈 상태) 탭이다. 여기서 모듈들의 보안 상태를 볼 수 있다.
   - 불완전한 열이 있으면 보안 구성을 끝낼수 없고 앱 상태가 초록색이거나 모든 구성을 완료하면 끝낼 수 있다.
3. Prototype/Demo에서 Production으로 보안레벨을 설정하고 Edit module security를 클릭한다.
4. Entity access 탭으로 이동하고 거기에 어떤 항목들이 있으면, 모두 지운다.



### Module Roles 만들기

1. 보안 설정을 해주면 MyFirstModule에 도메인 모델 아래에 보안 문서가 생겨난다.
   - 이 문서는 모듈 보안을 포함한다.
2. 보안 문서를 더블클릭해서 창을 열면 4가지의 탭이 있다.
3. Module roles를 정해주자.
   - 이번 학습에서는 Administrator, Teacher, Trainee 3가지를 정해주면 된다.
4. 확인을 누르고 창을 닫는다.



## Access Rules (액세스 규칙)

- 모듈 보안은 누가 무엇을 하게 할것인지 정하는 것이다.
- 페이지, 마이크로플로우, 엔티티 액세스에 따라서 정할 수 있다.
- 페이지 액세스
  - 어떤 페이지에 액세스 할 수 있는지를 정한다.
  - 네비게이션 바는 액세스가 가능한 페이지만 보여준다.
  - 액세스가 불가한 페이지로 가는 버튼이 있으면 이 버튼도 보여주지 않는다.
  - 페이지 액세스 설정에서는 페이지와 모듈 역할을 보여준다.
    - 각 조합에 따라 모듈 역할에 페이지가 액세스 권한이 있는지 여부를 나타낼 수 있다.
    - 페이지를 편집하는 동안에도 이 정보를 편집할 수 있다.
  - 고객들에게 직접 열린 페이지에만 적용되고 마이크로플로우에 의해 열리는 페이지는 역할이 마이크로플로우를 실행할 수 있는 경우에만 열린다.
- 마이크로플로우 액세스
  - on click 액션으로 마이크로플로우를 불러오는 네비게이션 아이템은 액세스가 허용된 유저한테만 보인다.
  - 페이지 액세스를 무효화 한다.
    - 만일 유저가 페이지를 보여주는 활동을 가진 마이크로플로우에 대한 액세스 권한은 있는데 그 페이지에 대한 액세스 권한이 없다고 해도 그 페이지를 열 수 있다.
  - 설정은 페이지 액세스와 동일 하다.
  - 이런 액세스 설정은 오직 마이크로플로우가 실행될 때만 확인된다.
  - 하위 마이크로플로우나 이벤트 핸들러로 설정된 마이크로플로우는 사용자가 호출하는 마이크로플로우에 액세스 할 수 있거나 관련 엔티티 이벤트가 사용자에게 허용된 경우 실행된다.
- 엔티티 액세스
  - 각 모듈 역할에 대해 사용자가 엔티티의 CRUD(Create, Read, Update, Delete) 객체에 대한 권한이 있는지 여부를 정한다.
  - 엔티티에 적용되는 액세스 규칙으로 구성된다.
  - 각 액세스 규칙은 차례로 하나 이상의 모듈 역할에 적용된다.
  - 엔티티의 액세스 규칙은 사용자가 해당 엔티티의 객체로 수행할 수 있는 작업을 정한다.
  - 사용자는 객체를 생성, 삭제하고 멤버(속성과 연결) 값을 보고 편집할 수 있다.
  - XPath 제약 조건을 통해 보기, 편집, 제거에 사용할 수 있는 객체 집합을 제한할 수 있다.



## 페이지와 마이크로플로우 액세스 설정

1. Module Security를 열고 Page Access 탭으로 간다.
2. 학습지의 예시테이블과 같이 페이지 액세스를  정해준다.
3. 페이지 액세스를 다 구성했으면 마이크로플로우 액세스 탭으로 넘어간다.
   - 오직 관리자만 교육이벤트를 CRUD 할 수 있다.
   - 선생님과 교육생은 이 기능에 액세스 할 수 없다.
4. 액세스 탭에서 3번의 기능들을 부여해준다.
5. 확인 버튼을 누르고 창을 닫는다.



### User Roles 만들기

1. App Security에 있는 User roles 탭을 연다.
2. 이미 관리자와 유저라는 2개의 roles가 있는데 유저이름을 선생님으로 바꿔준다.
3. 교육생이라는 user role이 필요하기 때문에 새로 하나 만들어준다.
   - 체크를 풀고 생성을 해준다 만일 체크를 풀지 않고 생성하면 오류가 난다.
   - 오류내용은 생성할 module role이 이미 있기 때문에 이다.
4. 관리자 role을 더블 클릭하여 속성창을 연다
5. 관리자로써 연결된 module roles의 리스트를 볼 수 있는데 Edit을 눌러 변경해준다. (관리자는 모든 모듈에서 관리자 권한을 갖는다.)
6. Teacher role은 시스템이랑 관리자 모듈에서 User이고 MyFirstModule에서는 Teacher이다.
7. Trainee role도 시스템이랑 관리자 모듈에서 User이고 MyFirstModule에서는 Trainee이다.



### 데모 유저 탭

- 앱을 테스트 해보고 싶을때 데모 유저를 만들면 된다.
- App security에서 4번째 탭에 데모 유저 탭이 있다.
- 앱에서 빠르게 user roles를 변환할 수 있다.
- 로그아웃 로그인 할 필요없이 바로 변환이 가능해서 편리하다.
- 앱을 실행시켜서 테스트한다.



### 역할 기반 홈페이지 설정

- 모든 user roles이 액세스 할 수 있는 페이지를 홈페이지로 만들어야 각자의 role들이 액세스 할 수 없는 버튼들이 지저분하게 있지 않는다.
- 이 설정은 네비게이션에서 할 수 있다.
- 설정 방법
  1. 네비게이션을 열고 Role based home page의 edit을 누른다.
  2. 창이 열리면 New를 눌러서 어떤 role을 선택할지 고른다
  3. 그 role에게 보여질 페이지를 Select target버튼을 눌러 골라준다.
  4. 앱을 다시 실행해주고 demo_trainee role을 선택해준다.





## 엔티티 액세스 설정

1. 엔티티 액세스를 설정하려면 보안레벨이 Production이여야한다.
2. Module Security를 열면 Entity access 탭이 생긴걸 볼 수 있다.
3. 도메인 모델의 엔티티와 상호작용할 수 있는 방법을 제어하는 각 모듈 roleㄴ에 대한 새 액세스 규칙을 만들어야 한다.
   - 관리자
     - 모든 권한을 갖는다.
   - 선생님
     - 읽기만 가능하다.
   - 교육자





## 앱 보안 사용자 설정

- Administrator 탭
  - 이 탭에서는 관리자의 이름과 비밀번호를 정할 수 있다.
  - 로컬 배포일 때 적용된다.
- Anonymous Users 탭
  - 이 탭에서는 익명의 유저를 받아들일지 아닐지를 고른다.
  - 받아들인다면 액세스 권한을 엄청 제한해놔야한다. 그렇지 않으면 누가 와서 데이터를 손 댈지 모르기 때문이다.
- Password Policy 탭
  - 이 탭에서는 사용자의 비밀번호를 얼마나 엄격하게 할 것인지 결정한다.
  - 최소길이는 얼마일지, 숫자나 특수 문자를 쓰게 할 것인지, 대소문자 혼합을 넣을 건지를 결정한다.